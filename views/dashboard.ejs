<%- include('layouts/layout', { title: 'Dashboard' }) %>

    <style>
      /* Modern small "X" delete button */
      .btn-close-style {
        background: none;
        /* remove solid background */
        color: #050505;
        /* red text color */
        border: none;
        /* no border */
        padding: 0 6px;
        /* compact horizontal padding */
        font-weight: bold;
        /* bold X */
        font-size: 0.9rem;
        /* slightly smaller text */
        line-height: 1;
        /* prevent vertical stretching */
        cursor: pointer;
      }

      .btn-close-style:hover {
        color: #a71d2a;
        /* darker red on hover */
        background: rgba(220, 53, 69, 0.1);
        /* subtle hover background */
        border-radius: 3px;
      }
    </style>

    <div class="container mt-4">
      <div class="row">
        <!-- Left column: Topics -->
        <div class="col-lg-4 mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h4">Your Topics</h2>
            <a class="btn btn-sm btn-success" href="/topics/new">+ New</a>
          </div>

          <% if (!topics || topics.length===0) { %>
            <div class="alert alert-info">No topics yet. Create your first one.</div>
            <% } else { %>
              <div class="list-group">
                <% topics.forEach(t=> {
                  const topicLogs = logs.filter(l => l.title === t.title);
                  %>
                  <div class="d-flex align-items-center mb-2">
                    <a href="/topics/<%= t.id %>"
                      class="list-group-item flex-grow-1 list-group-item-action shadow-sm rounded">
                      <strong>
                        <%= t.title %>
                      </strong>
                      <div class="small text-muted">
                        <%= new Date(t.created_at).toLocaleString() %>
                      </div>
                    </a>

                    <% if(topicLogs.length> 0){ %>
                      <button class="btn btn-sm btn-outline-primary ms-2 expand-logs-btn" data-topic="<%= t.title %>">
                        <i class="bi bi-journal-text"></i>
                        <%= topicLogs.length %>
                      </button>
                      <% } %>


                        <form action="/topics/<%= t.id %>/delete" method="POST" class="ms-2 d-inline"
                          onsubmit="return confirm('Are you sure you want to delete this topic? All related logs and resources will also be deleted.');">
                          <button type="submit" class="btn btn-sm btn-danger btn-close-style" title="Delete topic">
                            X
                          </button>
                        </form>

                        </form>
                  </div>
                  <% }) %>
              </div>
              <% } %>
        </div>

        <!-- Right column: Study Logs + Chart -->
        <div class="col-lg-8">
          <h3 class="h4 mb-3">Study Logs</h3>

          <% if (!logs || logs.length===0) { %>
            <div class="alert alert-warning">No logs yet.</div>
            <% } else { %>
              <div id="logs-accordion" class="mb-4">
                <% topics.forEach(t=> {
                  const topicLogs = logs.filter(l => l.title === t.title);
                  if(topicLogs.length === 0) return;
                  %>
                  <div class="accordion topic-logs mb-3 shadow-sm rounded" data-topic="<%= t.title %>">
                    <div class="accordion-header" id="heading-<%= t.id %>">
                      <button class="accordion-button collapsed bg-primary text-white fw-semibold" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapse-<%= t.id %>" aria-expanded="false"
                        aria-controls="collapse-<%= t.id %>">
                        <i class="bi bi-bookmark-fill me-2"></i>
                        <%= t.title %>
                      </button>
                    </div>
                    <div id="collapse-<%= t.id %>" class="accordion-collapse collapse">
                      <div class="accordion-body p-0">
                        <ul class="list-group list-group-flush">
                          <% topicLogs.forEach(l=> { %>
                            <li class="list-group-item d-flex justify-content-between align-items-start">
                              <div>
                                <a href="/study-logs/<%= l.id %>" target="_blank"
                                  class="fw-semibold text-decoration-none">
                                  <%= l.notes || 'No notes' %>
                                </a>
                                <small class="text-muted d-block">
                                  <%= new Date(l.created_at).toLocaleString() %>
                                </small>
                              </div>
                              <div class="d-flex align-items-center">
                                <span class="badge bg-success rounded-pill me-2">
                                  <%= l.duration_in_minutes %> min
                                </span>

                                <form action="/study-logs/<%= l.id %>/delete" method="POST" class="d-inline"
                                  onsubmit="return confirm('Are you sure you want to delete this study log?');">
                                  <button type="submit" class="btn btn-sm btn-danger btn-close-style"
                                    title="Delete study log">
                                    X
                                  </button>
                                </form>


                              </div>
                            </li>
                            <% }) %>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <% }) %>
              </div>

              <!-- Chart -->
              <div class="card shadow-sm rounded p-3 mb-4">
                <h5 class="card-title mb-3">Total Study Minutes per Topic</h5>
                <canvas id="studyTimeChart" height="150"></canvas>
              </div>
              <% } %>
        </div>
      </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const expandButtons = document.querySelectorAll('.expand-logs-btn');
        const accordions = document.querySelectorAll('.topic-logs');

        expandButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const topic = btn.getAttribute('data-topic');

            accordions.forEach(acc => {
              const collapse = acc.querySelector('.accordion-collapse');
              if (acc.getAttribute('data-topic') === topic) {
                collapse.classList.add('show');
              } else {
                collapse.classList.remove('show');
              }
            });

            document.querySelector('.col-lg-8').scrollIntoView({ behavior: "smooth" });
          });
        });

        // Chart.js - to show minutes studied per subjec
          const topics = <%- JSON.stringify(topics.map(t => t.title)) %>;
          const totalMinutes = <%- JSON.stringify(topics.map(t => {
            const topicLogs = logs.filter(l => l.title === t.title);
            return topicLogs.reduce((sum, l) => sum + l.duration_in_minutes, 0);
          })) %>;
        
        const canvas = document.getElementById('studyTimeChart');
        if (!canvas) {
          console.error("Canvas element not found");
          return;
        }
        const ctx = canvas.getContext('2d');

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: topics,
            datasets: [{
              label: 'Total Minutes',
              data: totalMinutes,
              backgroundColor: 'rgba(54, 162, 235, 0.7)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1,
              borderRadius: 5
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Minutes'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Topics'
                }
              }
            }
          }
        });
      });
    </script>